μΆ‹λ‹¤, μ΄μ  β€μ μΌ μ•„λκΉμ§€ ν™”μ‚΄ν‘κ°€ λ‚΄λ ¤κ°€κ²β€ λ§λ“¤μ π

μ”μ²­ν• λ€λ΅:

* UC-01~UC-04μ— ν•„μ”ν• κ²ƒλ§ μ μ§€
* μ„λ²„λ³„ / λ μ΄μ–΄λ³„λ΅
* κ° μ»΄ν¬λ„νΈκ°€ **Provided / Required μΈν„°νμ΄μ¤**
* νΉν **λ§¨ μ•„λ Infra μ»΄ν¬λ„νΈκ°€ μ–΄λ–¤ external μ¶”μƒ μΈν„°νμ΄μ¤(IDbQuery λ“±)λ¥Ό Required** ν•λ”μ§€κΉμ§€ λ…μ‹

μ½”λ“κ°€ μ•„λ‹λΌ **EA λ‹¤μ΄μ–΄κ·Έλ¨ κ·Έλ¦΄ λ• μ°Έκ³ ν•λ” μ„¤κ³„ μ„¤λ…** ν•νƒλ΅ μ“Έκ².

---

## κ³µν†µ: μµν•λ‹¨(External) μ¶”μƒ μΈν„°νμ΄μ¤

μ•„λ κ²ƒλ“¤μ€ μ‹¤μ  DB λ“λΌμ΄λ²„/HTTP ν΄λΌμ΄μ–ΈνΈ/μΉ΄ν”„μΉ΄ ν΄λΌμ΄μ–ΈνΈ/OS μ¤μΌ€μ¤„λ¬λ¥Ό κ°μ‹Έλ” β€ν”λ«νΌ μΈν„°νμ΄μ¤β€λΌκ³  λ³΄λ©΄ λλ‹¤.

```text
interface IDbQuery {
  Result execute(sql: string, params?: any[])
  Rows   query(sql: string, params?: any[])
}

interface ITimeSeriesDbClient {
  Result write(metric: string, tags: map, fields: map, time: Timestamp)
  Rows   query(queryText: string)
}

interface IKafkaProducer {
  Result send(topic: string, key: string, value: any)
}

interface IKafkaConsumer {
  void subscribe(topic: string, handler: (key: string, value: any) -> void)
}

interface IRestClient {
  HttpResponse request(method: string, url: string, body?: any, headers?: map)
}

interface ISystemScheduler {
  void scheduleEveryMinute(handler: () -> void)
}
```

μ΄μ  μ„λ²„λ³„λ΅ λ‚΄λ ¤κ°€ λ³΄μ.

---

## 1. HVAC Server (UC-01 ν™κ²½μμ‹ , UC-02 κ³µμ΅°μ μ–΄)

### 1) Presentation Layer

**μ»΄ν¬λ„νΈ: `HVACApiController`**

* **Provided**

  * `IHVACControlAPI`

    * `Result requestImmediateControl(WarehouseId)`
    * `ControlStatus getControlStatus(WarehouseId, ZoneId?)`
  * `IHVACStatusAPI`

    * `ControlStatus getLastControlResult(CommandId)`
* **Required**

  * `IHVACControlService`
  * `IHVACStatusQueryService`

(β†’ EA λ‹¤μ΄μ–΄κ·Έλ¨μ—μ„ μ„μ— λ‘ μΈν„°νμ΄μ¤ μ•„μ΄μ½, μ•„λμ— Controller μ»΄ν¬λ„νΈ, μ•„λλ΅ App λ μ΄μ–΄ μ„λΉ„μ¤λ“¤μ— required μ—°κ²°)

---

### 2) Application Layer

**a. `HVACControlService`**

* **Provided**

  * `IHVACControlService`

    * `Result requestHVACControl(WarehouseId)`
  * `IEnvSampleEventHandler` (μ½λ°±)

    * `void onEnvSample(SensorId, EnvSampleIn)`
* **Required**

  * `IEnvSampleSubscription`        (μ΄κΈ° μ½λ°± λ“±λ΅)
  * `IHVACDeviceConfigRepository`   (μ„Όμ„β†’μ¥μΉ/μ°½κ³  λ§¤ν•‘, μ¥μΉ λ©λ΅)
  * `IPolicyReferenceRepository`    (ControlPolicy μ΅°ν)
  * `IEnvTimeseriesRepository_HVAC` (Env μ €μ¥/μ΅°ν)
  * `ISetpointCalculationService`
  * `IDeviceCommandService`
  * `IControlHistoryRepository_HVAC`
  * `IPushClient` (μ—λ¬ μ•λ¦Ό)

**b. `HVACStatusQueryService`**

* **Provided**

  * `IHVACStatusQueryService`

    * `ControlStatus getStatus(WarehouseId, ZoneId?)`
    * `ControlStatus getByCommandId(CommandId)`
* **Required**

  * `IControlHistoryRepository_HVAC`
  * `IHVACDeviceConfigRepository`

**c. `SetpointCalculationService`**

* **Provided**

  * `ISetpointCalculationService`

    * `ControlCommand[] calculate(EnvSample, ControlPolicy, Device[])`
* **Required**

  * (μµμ…) `IEnvTimeseriesRepository_HVAC`

**d. `DeviceCommandService`**

* **Provided**

  * `IDeviceCommandService`

    * `Result executeCommands(ControlCommand[] cmds)`
* **Required**

  * `IDeviceCommandPublishing`       (μΉ΄ν”„μΉ΄λ΅ λ…λ Ή λ°ν–‰ μ‹)
  * `ISamsungHVACClient`
  * `ILGHVACClient`
  * `IControlHistoryRepository_HVAC`

---

### 3) Infrastructure Layer (HVAC)

μ—¬κΈ°κ°€ μ§λ¬Έν• β€μµν•λ‹¨ Requiredβ€ ν¬μΈνΈ.

**a. `BrokerGatewayForHVAC`**

* **Provided (μ„ Appμ— μ κ³µ)**

  * `IEnvSampleSubscription`

    * `void registerEnvSampleHandler(IEnvSampleEventHandler h)`
  * `IDeviceCommandPublishing`

    * `Result publishDeviceCommand(ControlCommand cmd)`
* **Required (ν”λ«νΌ)**

  * `IKafkaConsumer`  (μ„Όμ„ ν† ν”½ κµ¬λ…)
  * `IKafkaProducer`  (μ μ–΄λ…λ Ή ν† ν”½ λ°ν–‰)

**b. `HVACMasterDBAccess`**

* **Provided**

  * `IHVACDeviceConfigRepository`

    * `Device? findBySensorId(SensorId)`
    * `Device[] findByWarehouse(WarehouseId)`
  * `IPolicyReferenceRepository`

    * `ControlPolicy? getPolicy(WarehouseId, ZoneId)`
* **Required**

  * `IDbQuery` (RDBMS μ ‘μ†: Master DB)

**c. `HVACTimeseriesDBAccess`**

* **Provided**

  * `IEnvTimeseriesRepository_HVAC`

    * `Result saveEnv(EnvSample)`
    * `EnvSample? getLatest(WarehouseId, ZoneId)`
  * `IControlHistoryRepository_HVAC`

    * `Result save(ControlStatus)`
    * `ControlStatus? findByCommandId(CommandId)`
    * `ControlStatus[] listByWarehouse(WarehouseId, TimeRange)`
* **Required**

  * `ITimeSeriesDbClient` (InfluxDB λ“±)

**d. Vendor Clients**

* `SamsungHVACClient`

  * **Provided**: `ISamsungHVACClient.send(ControlCommand[] cmds): Result`
  * **Required**: `IRestClient` (μ‚Όμ„± API μ—”λ“ν¬μΈνΈ)
* `LGHVACClient`

  * **Provided**: `ILGHVACClient.send(ControlCommand[] cmds): Result`
  * **Required**: `IRestClient`
* `PushClient`

  * **Provided**: `IPushClient.send(msg, target): PushResult`
  * **Required**: `IRestClient` (μΉ΄μΉ΄μ¤ν†΅/FCM λ“± Push μ„λ²„)

EA λ„μ‹μΌλ΅λ”:
App λ μ΄μ–΄ β†’(required) Repo/Client μΈν„°νμ΄μ¤ β†’ Infra μ»΄ν¬λ„νΈ β†’(required) IDbQuery/IKafka/IRest κ°™μ€ μµν•λ‹¨ λ…Έλ“(μ™Έλ¶€ μ‹μ¤ν…).

---

## 2. Monitoring Server (UC-03/04 Heartbeat)

### 1) Presentation Layer

**`MonitoringApiController`**

* **Provided**

  * `IMonitoringQueryAPI`

    * `DeviceStatus[] getDeviceStatuses(WarehouseId)`
    * `Heartbeat[] getHeartbeatHistory(WarehouseId, DeviceId, TimeRange)`
  * `IAlarmQueryAPI`

    * `Alarm[] getActiveAlarms(WarehouseId?)`
    * `Alarm[] getAlarmHistory(WarehouseId?, TimeRange?)`
* **Required**

  * `IMonitoringQueryService`
  * `IAlarmManagementService`

---

### 2) Application Layer

**a. `DeviceHealthCheckScheduler`**

* **Provided**

  * `I1MinTickListener`

    * `void on1MinTick()`
* **Required**

  * `I1MinTimerRegistration`       (TimerGateway)
  * `IDeviceHealthCheckService`    (tickμ‹ νΈμ¶)

**b. `DeviceHealthCheckService`**

* **Provided**

  * `IDeviceHealthCheckService`

    * `void checkAllDevices()`
* **Required**

  * `IMonDeviceConfigRepository`      (λ¨λ‹ν„°λ§ λ€μƒ μ¥μΉ λ©λ΅)
  * `ISamsungHVACStatusClient`
  * `ILGHVACStatusClient`
  * `IDeviceHeartbeatRepository`
  * `IAlarmManagementService`        (DOWN μ‹ μ•λ μ„μ„)

**c. `AlarmManagementService`**

* **Provided**

  * `IAlarmManagementService`

    * `Alarm raiseDeviceDown(Device)`
    * `Result closeIfRecovered(Device)`
    * `Alarm[] getActiveAlarms(WarehouseId?)`
    * `Alarm[] getAlarmHistory(WarehouseId?, TimeRange?)`
* **Required**

  * `IPushClient`
  * `IDeviceStatusHistoryRepository`

**d. `MonitoringQueryService`**

* **Provided**

  * `IMonitoringQueryService`

    * `DeviceStatus[] getDeviceStatuses(WarehouseId)`
    * `Heartbeat[] getHeartbeatHistory(WarehouseId, DeviceId, TimeRange)`
* **Required**

  * `IDeviceHeartbeatRepository`
  * `IDeviceStatusHistoryRepository`

---

### 3) Infrastructure Layer (Monitoring)

**a. `TimerGateway`**

* **Provided**

  * `I1MinTimerRegistration`

    * `void register(I1MinTickListener listener)`
* **Required**

  * `ISystemScheduler` (OS/ν”λ«νΌ νƒ€μ΄λ¨Έ)

**b. `MonMasterDBAccess`**

* **Provided**

  * `IMonDeviceConfigRepository`

    * `Device[] listAllMonitoredDevices()`
* **Required**

  * `IDbQuery` (λ¨λ‹ν„°λ§μ© Master DB)

**c. `MonTimeseriesDBAccess`**

* **Provided**

  * `IDeviceHeartbeatRepository`

    * `Result save(Heartbeat)`
    * `Heartbeat[] list(WarehouseId, DeviceId, TimeRange)`
  * `IDeviceStatusHistoryRepository`

    * `Result save(DeviceStatus)`
    * `DeviceStatus[] list(WarehouseId?, TimeRange?)`
* **Required**

  * `ITimeSeriesDbClient`

**d. Vendor Status Clients**

* `SamsungHVACStatusClient`

  * **Provided**: `ISamsungHVACStatusClient.getStatus(Device): DeviceStatus`
  * **Required**: `IRestClient`
* `LGHVACStatusClient`

  * **Provided**: `ILGHVACStatusClient.getStatus(Device): DeviceStatus`
  * **Required**: `IRestClient`

**e. `PushClient`**

* **Provided**: `IPushClient.send(message, target): PushResult`
* **Required**: `IRestClient` (Push μ„λ²„)

---

## 3. Master/Ops μ½ (UC-01~04 λ²”μ„μ—μ„ ν•„μ”ν• κ²ƒλ§)

HVAC/Monitoring μ„λ²„ μ…μ¥μ—μ„ λ³΄λ©΄ β€μ™Έλ¶€ μ‹μ¤ν…/DB λ…Έλ“β€ μ—­ν• .

**a. `ZoneProfileRepository` / `WarehouseDeviceRepository` (Master DB)**

* **Provided** (MasterDBAccess λ“±μ—μ„ κµ¬ν„)

  * `ControlPolicy? getPolicy(WarehouseId, ZoneId)`
  * `Device? findBySensorId(SensorId)`
  * `Device[] findByWarehouse(WarehouseId)`
* **Required**

  * `IDbQuery`

EA λ‹¤μ΄μ–΄κ·Έλ¨μ—μ„:

* HVAC/Monitoring μ„λ²„μ Repo μ»΄ν¬λ„νΈ β†’(required) `IDbQuery` β†’ Master DB λ…Έλ“
* HVAC μ„λ²„μ BrokerGateway β†’(required) `IKafka...` β†’ Kafka λ…Έλ“
* Monitoring μ„λ²„μ TimerGateway β†’(required) `ISystemScheduler` β†’ OS Scheduler λ…Έλ“
* Vendor/Push Client β†’(required) `IRestClient` β†’ κ° Vendor/Push λ…Έλ“

μ΄λ ‡κ² κ·Έλ¦¬λ©΄ β€κ° λ…Έλ“μ μµν•λ‹¨ Required μΈν„°νμ΄μ¤κ°€ μ™Έλ¶€ μ‹μ¤ν…κ³Ό μ–΄λ–¤ μ‹μΌλ΅ μ—°κ²°λλ”μ§€β€κ°€ ν•λμ— λ³΄μ΄κ³ , μ‹¬μ‚¬ λ•λ„

> μƒμ„(App)λ” Infra μΈν„°νμ΄μ¤λ§ μ•κ³ , Infraλ” λ‹¤μ‹ IDbQuery/IKafka/IRest κ°™μ€ ν•μ„ ν”λ«νΌμ— μμ΅΄ν•λ‹¤

λ” κµ¬μ΅°λ¥Ό λ…ν™•ν μ„¤λ…ν•  μ μμ–΄.














